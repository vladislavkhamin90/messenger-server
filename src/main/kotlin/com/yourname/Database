import org.jetbrains.exposed.sql.*
import org.jetbrains.exposed.sql.transactions.transaction
import java.sql.Connection

object Users : Table() {
    val id = varchar("id", 36).primaryKey()
    val username = varchar("username", 50).uniqueIndex()
    val email = varchar("email", 100).uniqueIndex()
    val passwordHash = varchar("password_hash", 100)
}

object Notes : Table() {
    val id = varchar("id", 36).primaryKey()
    val userId = varchar("user_id", 36).references(Users.id)
    val title = varchar("title", 200)
    val content = text("content")
    val createdAt = long("created_at")
    val updatedAt = long("updated_at")
}

fun Application.configureDatabase() {
    val databaseUrl = System.getenv("DATABASE_URL")
    
    val (url, user, password) = if (databaseUrl != null) {
        // Формат: postgresql://user:password@host:port/database
        val regex = Regex("postgresql://(.+):(.+)@(.+):(\\d+)/(.+)")
        val match = regex.find(databaseUrl)!!
        val (user, password, host, port, database) = match.destructured
        Triple("jdbc:postgresql://$host:$port/$database", user, password)
    } else {
        // Локальная разработка
        Triple("jdbc:postgresql://localhost:5432/notesdb", "postgres", "password")
    }
    
    Database.connect(
        url = url,
        driver = "org.postgresql.Driver",
        user = user,
        password = password
    )
    
    transaction {
        SchemaUtils.create(Users, Notes)
    }
}
